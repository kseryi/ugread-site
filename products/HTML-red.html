<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Веб-редактор — HTML / CSS / JS з Images & ZIP (з Drag&Drop)</title>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material.min.css">

  <style>
    :root{--bg:#0b0f14;--panel:#0f1418;--muted:#9aa2aa;--accent:#06f;--divider:#1f2933;--editor-bg:#071017;--text:#dbe6ea}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .app{height:100vh;display:flex;align-items:stretch}
    .left{display:flex;flex-direction:column;min-width:260px;background:var(--panel);overflow:hidden}
    .right{flex:1;display:flex;flex-direction:column;background:#061117}
    .divider{width:8px;cursor:col-resize;background:linear-gradient(180deg,var(--divider),transparent)}
    .tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.03)}
    .tab{padding:10px 14px;cursor:pointer;user-select:none;color:var(--muted);border-right:1px solid rgba(255,255,255,0.02)}
    .tab.active{color:var(--text);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .editors{flex:1;display:flex;flex-direction:column;gap:0;overflow:hidden;padding:10px}
    .CodeMirror{height:100%;border-radius:8px;background:var(--editor-bg);color:var(--text)}
    .toolbar{display:flex;gap:8px;padding:8px;border-top:1px solid rgba(255,255,255,0.02);align-items:center;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:6px;color:var(--muted);cursor:pointer;transition:0.15s}
    .btn:hover{background:rgba(255,255,255,0.03)}
    .btn.primary{border-color:var(--accent);color:var(--accent)}
    .preview-head{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:8px}
    .preview-head .label{color:var(--muted);font-size:13px}
    iframe#preview{flex:1;border:0;width:100%;height:100%}
    /* images tab */
    #images { display:none; padding:10px; overflow:auto; color:var(--text); border-radius:6px }
    #images.dropover { outline: 2px dashed rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    #imgList img { width:80px; height:80px; object-fit:cover; border-radius:6px; margin:6px; cursor:pointer; border:1px solid rgba(255,255,255,0.04) }
    #imgList .item { display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted) }
    .small{font-size:12px;color:var(--muted)}
    input[type="file"]{color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .flex1{flex:1}
    code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:4px;color:var(--muted)}
    @media (max-width:700px){ .left{min-width:140px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="left" id="left">
      <div class="tabs">
        <div class="tab active" data-tab="html">HTML</div>
        <div class="tab" data-tab="css">CSS</div>
        <div class="tab" data-tab="js">JS</div>
        <div class="tab" data-tab="images">Images</div>
      </div>

      <div class="editors" id="editorsRoot">
        <!-- fallback textareas (CodeMirror will replace) -->
        <textarea id="html" spellcheck="false"><!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Моя сторінка</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Привіт, світ!</h1>
  <p>Приклад зображення: &lt;img src="images/image_1.png"&gt;</p>
  <img src="images/image_1.png" alt="test">
  <script src="script.js"></script>
</body>
</html></textarea>

        <textarea id="css" style="display:none">body { font-family: Arial, sans-serif; background:#fff; color:#222; padding:20px }
h1{color:#0a58a8}</textarea>

        <textarea id="js" style="display:none">console.log('JS готовий');</textarea>

        <!-- Images tab content (hidden by default) -->
        <div id="images">
          <div class="row" style="margin-bottom:8px;">
            <input type="file" id="imgUpload" accept="image/*" multiple />
            <input type="url" id="imgUrl" class="flex1" placeholder="Встав URL зображення (http...)" style="padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#0b1115;color:var(--text)">
            <button id="loadUrl" class="btn">Завантажити з URL</button>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <button id="clearImages" class="btn">Очистити зображення</button>
            <button id="copyAllPaths" class="btn">Копіювати всі шляхи</button>
            <div style="flex:1"></div>
            <div class="small">Клік по картинці — скопіює <code>images/ім'я</code></div>
          </div>
          <div id="imgList" style="display:flex; flex-wrap:wrap"></div>
        </div>
      </div>

      <div class="toolbar">
        <button id="runBtn" class="btn primary">Оновити</button>
        <button id="formatBtn" class="btn">Формат</button>

        <label class="btn" title="Імпортувати файл .html/.css/.js або .zip">
          Імпорт файлів
          <input id="fileImport" type="file" accept=".html,.htm,.css,.js,.zip" style="display:none">
        </label>

        <button id="downloadBtn" class="btn">⬇️ Експорт ZIP</button>

        <div style="flex:1"></div>
        <div class="small">Авто: <input type="checkbox" id="auto" checked /></div>
      </div>
    </div>

    <div class="divider" id="divider" title="Тягніть щоб змінити ширину"></div>

    <div class="right">
      <div class="preview-head">
        <div class="label">Попередній перегляд</div>
        <div style="flex:1"></div>
        <div class="label" id="sizeLabel"></div>
      </div>
      <iframe id="preview" sandbox="allow-scripts allow-forms allow-modals"></iframe>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // === Ініціалізація CodeMirror ===
    const cmOptions = {theme: 'material', lineNumbers: true, tabSize: 2, indentUnit: 2, autoCloseTags: true, autoCloseBrackets: true, lineWrapping: true};
    const cmHtml = CodeMirror.fromTextArea(document.getElementById('html'), Object.assign({mode: 'htmlmixed'}, cmOptions));
    const cmCss  = CodeMirror.fromTextArea(document.getElementById('css'),  Object.assign({mode: 'css'}, cmOptions));
    const cmJs   = CodeMirror.fromTextArea(document.getElementById('js'),   Object.assign({mode: 'javascript'}, cmOptions));
    const editorsCm = { html: cmHtml, css: cmCss, js: cmJs };

    // UI елементи
    const tabs = document.querySelectorAll('.tab');
    const preview = document.getElementById('preview');
    const autoCheckbox = document.getElementById('auto');
    const runBtn = document.getElementById('runBtn');
    const formatBtn = document.getElementById('formatBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const sizeLabel = document.getElementById('sizeLabel');
    const fileImport = document.getElementById('fileImport');

    // Images UI
    const imagesTab = document.getElementById('images');
    const imgUpload = document.getElementById('imgUpload');
    const imgUrlInput = document.getElementById('imgUrl');
    const loadUrlBtn = document.getElementById('loadUrl');
    const imgList = document.getElementById('imgList');
    const clearImagesBtn = document.getElementById('clearImages');
    const copyAllPathsBtn = document.getElementById('copyAllPaths');

    // Зберігання зображень у сесії
    // elements: { name: string, blob: Blob, thumbUrl: objectURL }
    const imageFiles = [];

    // Підтримка переключення вкладок
    function showTab(key){
      tabs.forEach(x=>x.classList.toggle('active', x.dataset.tab===key));
      for(const k in editorsCm){
        const w = editorsCm[k].getWrapperElement();
        w.style.display = (k===key)?'block':'none';
        if(k===key) editorsCm[k].refresh();
      }
      // images tab display
      imagesTab.style.display = (key==='images')?'block':'none';
      // refresh editors
      Object.values(editorsCm).forEach(cm=>cm.refresh());
    }
    tabs.forEach(t=>t.addEventListener('click', ()=>{ showTab(t.dataset.tab); }));
    showTab('html');

    // === Preview building: заміна посилань images/... на objectURL ===
    let previewImageUrls = []; // тимчасові objectURL, які створюємо для preview (revoke після)
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function buildPreviewSrc(html, css){
      // очистити старі тимчасові URL
      previewImageUrls.forEach(u=>URL.revokeObjectURL(u));
      previewImageUrls = [];

      // комбінуємо
      let combined = `<!doctype html><html><head><meta charset="utf-8"><style>${css}</style></head><body>${html}`;

      // Для кожного зареєстрованого зображення замінимо посилання images/NAME -> objectURL
      imageFiles.forEach(img=>{
        const objUrl = URL.createObjectURL(img.blob);
        previewImageUrls.push(objUrl);

        const esc = escapeRegExp(img.name);

        // заміна у лапках: src="images/name" або src='images/name'
        combined = combined.replace(new RegExp(`(["'])images/${esc}\\1`, 'g'), `"${objUrl}"`);
        // src=images/name (без лапок)
        combined = combined.replace(new RegExp(`src=images/${esc}`, 'g'), `src="${objUrl}"`);
        // srcset: multiple entries, будемо міняти occurrences images/name
        combined = combined.replace(new RegExp(`images/${esc}`, 'g'), objUrl);
        // url(...) в CSS або style атрибутах
        combined = combined.replace(new RegExp(`url\\(\\s*['"]?images/${esc}['"]?\\s*\\)`, 'g'), `url(${objUrl})`);
      });

      combined += `</body></html>`;
      return combined;
    }

    // Оновлення preview
    function updatePreview(){
      const html = editorsCm.html.getValue();
      const css = editorsCm.css.getValue();
      const src = buildPreviewSrc(html, css);
      preview.srcdoc = src;
    }

    // debounce автоперегляду
    let timeout = null;
    function scheduleUpdate(){
      if(!autoCheckbox.checked) return;
      if(timeout) clearTimeout(timeout);
      timeout = setTimeout(updatePreview, 250);
    }

    Object.values(editorsCm).forEach(cm=>cm.on('change', scheduleUpdate));
    runBtn.addEventListener('click', updatePreview);

    // Формат (дуже просте)
    formatBtn.addEventListener('click', ()=>{
      editorsCm.html.setValue(editorsCm.html.getValue().split('\n').map(l=>l.trimEnd()).join('\n').replace(/>\s+</g,'><'));
      editorsCm.css.setValue(editorsCm.css.getValue().split('\n').map(l=>l.trimEnd()).join('\n'));
      editorsCm.js.setValue(editorsCm.js.getValue().split('\n').map(l=>l.trimEnd()).join('\n'));
      scheduleUpdate();
    });

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); updatePreview(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); updatePreview(); }
    });

    // === Resizer: реагує тільки на ліву кнопку миші (button === 0) ===
    (function initResizer(){
      const divider = document.getElementById('divider');
      const left = document.getElementById('left');

      divider.addEventListener('mousedown', (e)=>{
        // тільки ліва кнопка
        if(e.button !== 0) return;
        e.preventDefault();
        document.body.style.userSelect = 'none';

        const moveHandler = (ev) => {
          // Якщо у деяких середовищах кнопка відпущена, можна також перевіряти ev.buttons
          if(typeof ev.buttons !== 'undefined' && (ev.buttons & 1) === 0){
            // ліва кнопка вже відпущена — знімаємо слухачі
            upHandler();
            return;
          }
          const total = document.querySelector('.app').clientWidth;
          let newW = ev.clientX;
          const min = 180, max = total - 200;
          if(newW < min) newW = min;
          if(newW > max) newW = max;
          left.style.width = newW + 'px';
          sizeLabel.textContent = `Ширина редактора: ${Math.round(newW)}px`;
          Object.values(editorsCm).forEach(cm=>cm.refresh());
        };

        const upHandler = () => {
          document.body.style.userSelect = 'auto';
          window.removeEventListener('mousemove', moveHandler);
          window.removeEventListener('mouseup', upHandler);
        };

        window.addEventListener('mousemove', moveHandler);
        window.addEventListener('mouseup', upHandler);
      });

      // також підтримка pointer events як запасний варіант (для сенсорних)
      divider.addEventListener('pointerdown', (e)=>{
        if(e.isPrimary && e.button === 0){
          // дозволимо mousedown логіці обробити; pointer events змінюють поведінку в різних браузерах
        }
      });
    })();

    // ========== Images logic (drag & drop + upload + URL) ==========
    function renderImages(){
      imgList.innerHTML = '';
      imageFiles.forEach((img)=>{
        const div = document.createElement('div');
        div.className = 'item';
        const imageEl = document.createElement('img');
        imageEl.src = img.thumbUrl; // thumbnail objectURL
        imageEl.title = img.name;
        imageEl.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(`images/${img.name}`);
            alert(`Скопійовано: images/${img.name}`);
          } catch (e) {
            prompt('Скопіюйте шлях вручну:', `images/${img.name}`);
          }
        });
        const label = document.createElement('div');
        label.className = 'small';
        label.textContent = img.name;
        div.appendChild(imageEl);
        div.appendChild(label);
        imgList.appendChild(div);
      });
    }

    // додавання локальних зображень (input)
    imgUpload.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      addFilesAsImages(files);
      e.target.value = '';
    });

    // drag & drop support for images tab
    (function initDragDrop(){
      const dropArea = document.getElementById('images');
      dropArea.addEventListener('dragover', (e)=>{ e.preventDefault(); dropArea.classList.add('dropover'); });
      dropArea.addEventListener('dragleave', (e)=>{ e.preventDefault(); dropArea.classList.remove('dropover'); });
      dropArea.addEventListener('drop', (e)=>{
        e.preventDefault(); dropArea.classList.remove('dropover');
        const dt = e.dataTransfer;
        if(!dt) return;
        const files = Array.from(dt.files || []).filter(f => f.type.startsWith('image/'));
        if(files.length) addFilesAsImages(files);
        // handle links/text (image URLs) dragged in
        const url = dt.getData('text/uri-list') || dt.getData('text/plain');
        if(url && !files.length){
          loadImageFromUrl(url);
        }
      });
    })();

    function addFilesAsImages(files){
      files.forEach(file=>{
        if(!file.type.startsWith('image/')) return;
        const ext = file.name.includes('.') ? file.name.slice(file.name.lastIndexOf('.')).toLowerCase() : ('.' + file.type.split('/')[1]);
        const name = makeUniqueImageName(ext);
        const thumbUrl = URL.createObjectURL(file);
        imageFiles.push({ name, blob: file, thumbUrl });
      });
      renderImages();
      scheduleUpdate();
    }

    // допоміжна функція: унікальне ім'я
    function makeUniqueImageName(ext){
      let i = 1;
      while(true){
        const candidate = `image_${i}${ext}`;
        if(!imageFiles.some(x=>x.name===candidate)) return candidate;
        i++;
      }
    }

    // Завантаження з URL (fetch -> blob)
    loadUrlBtn.addEventListener('click', async ()=>{
      const url = imgUrlInput.value.trim();
      if(!url) return alert('Вставте URL зображення.');
      await loadImageFromUrl(url);
      imgUrlInput.value = '';
    });

    async function loadImageFromUrl(url){
      try {
        // поширені проблеми: CORS — про це повідомляємо користувача
        const resp = await fetch(url, { mode: 'cors' });
        if(!resp.ok) throw new Error(`Помилка ${resp.status}`);
        const blob = await resp.blob();
        if(!blob.type.startsWith('image/')) throw new Error('Отриманий ресурс не є зображенням.');
        // визначити розширення з content-type або з URL
        let ext = '';
        if(blob.type && blob.type.includes('/')) {
          const t = blob.type.split('/')[1];
          ext = t.includes('png')?'.png': t.includes('jpeg')||t.includes('jpg')?'.jpg': t.includes('gif')?'.gif': t.includes('webp')?'.webp': '.'+t;
        } else {
          const match = url.match(/\.([a-zA-Z0-9]+)(?:[?#]|$)/);
          ext = match? '.' + match[1] : '.png';
        }
        const name = makeUniqueImageName(ext);
        const thumbUrl = URL.createObjectURL(blob);
        imageFiles.push({ name, blob, thumbUrl });
        renderImages();
        scheduleUpdate();
      } catch(err){
        alert('Не вдалося завантажити зображення: ' + err.message + '\n(якщо це зовнішній ресурс, переконайся, що сервер дозволяє CORS)');
      }
    }

    // очистити
    clearImagesBtn.addEventListener('click', ()=>{
      imageFiles.forEach(i=>URL.revokeObjectURL(i.thumbUrl));
      imageFiles.length = 0;
      renderImages();
      scheduleUpdate();
    });

    // скопіювати всі шляхи
    copyAllPathsBtn.addEventListener('click', async ()=>{
      if(imageFiles.length === 0) return alert('Немає зображень');
      const list = imageFiles.map(i => `images/${i.name}`).join('\n');
      try {
        await navigator.clipboard.writeText(list);
        alert('Скопійовано всі шляхи до буфера обміну');
      } catch(e){
        prompt('Скопіюйте список вручну:', list);
      }
    });

    // ========== Import files (single files or zip) ==========
    fileImport.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      if(f.name.toLowerCase().endsWith('.zip')){
        // розпаковка ZIP
        try {
          const z = await JSZip.loadAsync(f);
          const entries = Object.keys(z.files);
          for(const path of entries){
            if(z.files[path].dir) continue;
            const lower = path.toLowerCase();
            const content = await z.files[path].async('arraybuffer');
            // якщо файл у папці images/ — додати до imageFiles
            if(lower.startsWith('images/')){
              const blob = new Blob([content], { type: inferMimeFromExt(path) });
              const ext = path.slice(path.lastIndexOf('.')).toLowerCase() || '.png';
              const name = makeUniqueImageName(ext);
              const thumbUrl = URL.createObjectURL(blob);
              imageFiles.push({ name, blob, thumbUrl });
            } else if(lower.endsWith('.html') || lower.endsWith('.htm')){
              const text = new TextDecoder().decode(content);
              editorsCm.html.setValue(text);
            } else if(lower.endsWith('.css')){
              const text = new TextDecoder().decode(content);
              editorsCm.css.setValue(text);
            } else if(lower.endsWith('.js')){
              const text = new TextDecoder().decode(content);
              editorsCm.js.setValue(text);
            }
          }
          renderImages();
          scheduleUpdate();
        } catch(err){
          alert('Помилка розпаковки ZIP: ' + err.message);
        }
      } else {
        // окремий файл
        const lower = f.name.toLowerCase();
        const text = await f.text();
        if(lower.endsWith('.html')||lower.endsWith('.htm')) editorsCm.html.setValue(text);
        else if(lower.endsWith('.css')) editorsCm.css.setValue(text);
        else if(lower.endsWith('.js')) editorsCm.js.setValue(text);
        else alert('Невідомий тип файлу: ' + f.name);
        scheduleUpdate();
      }
      e.target.value = '';
    });

    function inferMimeFromExt(path){
      const ext = path.slice(path.lastIndexOf('.')+1).toLowerCase();
      if(ext==='png') return 'image/png';
      if(ext==='jpg' || ext==='jpeg') return 'image/jpeg';
      if(ext==='gif') return 'image/gif';
      if(ext==='webp') return 'image/webp';
      return 'application/octet-stream';
    }

    // ========== Export ZIP ==========
    downloadBtn.addEventListener('click', async ()=>{
      const zip = new JSZip();
      zip.file('index.html', editorsCm.html.getValue());
      zip.file('style.css', editorsCm.css.getValue());
      zip.file('script.js', editorsCm.js.getValue());

      if(imageFiles.length){
        const folder = zip.folder('images');
        for(const img of imageFiles){
          // якщо blob — зберігаємо як-is
          folder.file(img.name, img.blob, { binary: true });
        }
      }
      const blob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'project.zip';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // стартове оновлення
    updatePreview();

    // очистка objectURLs при unload
    window.addEventListener('beforeunload', ()=>{
      previewImageUrls.forEach(u=>URL.revokeObjectURL(u));
      imageFiles.forEach(i=>URL.revokeObjectURL(i.thumbUrl));
    });
  </script>
</body>
</html>
